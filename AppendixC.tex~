\documentclass[main.tex]{subfiles}
\begin{document}
\glsresetall

\section{Introduction}

During the year 2016, a conectivity test was performed with 35 modules of the LST1 camera, to evaluate the integration of the electronics and mechanical structure. As explained in chapter \ref{cap:CTA}, the modules of the \gls{lst} are designed to be manipulated each individually, allowing the easy removal  and substitution of malfunctioning modules. The goals of the C35 test were to evaluate the interface between cluster mechanics and cluster holder, check the possible interference of modules during assembly, stablish an assembly procedure, find potential problemas during assembly and test assembly time, and check the interfaces between the different parts of the electronics such as the Dragon boards and mezzanines, and the connection between the clusters and the backplanes. During this test, 35 modules were assmebled in the camera plate in different configurations, and several connectivity tests were performed, such as tests on the clock, PPS, camera trigger and busy signals, power supply, trigger distribution along the camera, time delays configuration over.\\
In order to perform the tests involing the trigger system, it was necessary to design a calibration method for the L1 transfer function, to find the threshold voltage which produces a trigger rate of 50\% depending on the input signal.\\
In the next sections the calibration algorithm developed for this task is described and results on the calibration are commented. Note that this is the calibration method currently implemented in the telescope. 

\section{L1 transfer function calibration}

A method for the calibration of the L1 Analog Trigger system was developed and tested, based in a rate scan methodology. The goal of the calibration is to find the voltage threshold needed to
obtain a trigger rate of 50\%. The calibration need to be peformed for each module of the camera and done separately for each one of the three adders of the asic and for the two discriminatos
paired to each adder. The 50\% trigger rate threshold is obtained for several input signals in order to plot a curve that allows retrieving the gain and offset of the circuit, and compare them
with the characterization of the ASICs. \\
The setup for the calibration consists on one module where a pulse with fixed amplitude and frequency can be injected in each of its seven pixels by the Slow Control Board (SCB). Increasing
signals are generated by adding the pulses injected in each of the seven channel of the module, meaning that in total is possible to obtain up to 6 points for the calibration curve. \\
An algorithm based in a bisection method is applied to each input signal to calculate the 50\% trigger rate threshold.

\subsection{Calibration algorithm}

The algorithm for this calibration has been implemented using a scripting language specially designed for the C35 Test performed at CIEMAT integrating 35 modules in
the mechanics of LST1 camera. It proceeds by configuring a fixed gain an frequency pulse in the SCB, in a fixed number of pixel lines. This way, the amplitude of the pulses
can be modified by adding more pixels, so each pixel added sums 1x the amplitude of the initial pulse. \\
Once the initial pulse is configured, a bisection method is used to find the 50\% trigger rate threshold. The threshold voltage in the ASIC is configured through a DAC with 8 bits, that can
provide up to 255 different voltages from 0 to $1.2$V in steps of $4.8$mV. The algorithm initiates setting the threshold at the maximum voltage (setting the 8 bits to 1)
and runs bit by bit, from the most significant bit, changing 1 to 0. If the new threshold voltage provide a trigger rate that is less than the target rate (in this case
the target is 50\%) then that threshold voltage is stored and the algorithm goes to the next bit. This way, only 8 steps are necessary to find the required threshold voltage.
A diagram describing the algorithm is shown in figure~\ref{fig:calalgorith}.
\begin{figure}
  \centering
  \includegraphics[width=0.5\textwidth]{./Pictures/calibrationalgorithm.pdf}
  \caption{Flux diagram of the calibration algorithm.}
  \label{fig:calalgorith}
\end{figure}

Once the loop is finished, the 50\% trigger rate threshold is calculated following the formula:
\begin{equation}
  50TH = \frac{(Target Rate-Baseline)}{(Baseline-Rate[Current Threshold-1]} + Current Threshold
\end{equation}

Being baseline the rate at current threshold, say the last threshold that was stored in the loop.

\subsection{Calibration result}

When the full algorithm ends and runs over the 6 possible input signals, the obtained 50\% threshold can be plotted against the number of pixels
added to see the calibration curve (see figure ~\ref{fig:calibcurve}).

\begin{figure}
  \centering
  \includegraphics[width=0.5\textwidth]{./Pictures/calibcurve.pdf}
  \caption{Result of the rate scan for Adder A of one module}
  \label{fig:calibcurve}
\end{figure}

If the initial pulse injected by the SCB is known and assuming that the adding is correct, the amplitude of each pulse is simply the multiplication of the initial pulse by the number of pixels added, being possible to obtain the gain and offset of the asic.

\end{document}
